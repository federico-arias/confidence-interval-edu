<!DOCTYPE html>
<head>
  <meta charset="utf-8">
  <script src="d3.js"></script>
  <style>
	* {
		margin:0;padding:0;
	}

	svg {
	  font: 10px sans-serif;
	}

	.x-axis line,
	.x-axis path {
	  fill: none;
	  stroke: #000;
	  stroke-width: 1px;
	}

  </style>
</head>

<body>
  <script>
    var m = 20;
	var w = Math.max(document.documentElement.clientWidth, window.innerWidth || 0)/2 - 3*m;
	var h = Math.max(document.documentElement.clientHeight, window.innerHeight || 0)*(9/16) - 3*m;
    var vals = d3.range(100).map( d3.random.normal(170, 20) );

	var n = 10;
	var diff = d3.extent(vals).reduce( (pv,cv) => cv - pv)/ n;

	//repositions values to a binned interval
	var bins = d3.scale.quantize()
				.domain(d3.extent(vals))
				.range( d3.range(n).map( v=> v*diff + d3.min(vals)) );

	//from value to corresponding pixels
    var x = d3.scale.linear()
			.domain(d3.extent(vals))
			.range([0, w]);

	//max number of stacked rects
	var max = vals.map(bins).reduce( (pv, cv, i, a) => a.filter(v=>v==cv).length < pv ? pv : a.filter(v=>v==cv).length, 0);
	

    var y = d3.scale.linear()
		.domain([0,max])
	//substract the rect heigth
    	.range([h - 13, 0]);

	
	var xs = d3.scale.quantile() 
			.domain(d3.extent(vals.map(v=>Math.floor(v))))
			.range( d3.range(n).map( v=> v*(w/n)) );

	var xAxis = d3.svg.axis()
					.tickValues(d3.range(n).map( v=> v*diff + d3.min(vals)).map(v=>Math.floor(v)))
					.ticks(11)
					.scale(xs);

	function counter() {
		var counts = {};
		return function (d) {
			if (typeof counts[d.bin] == 'undefined')  
				counts[d.bin] = -1;
			return y(++counts[d.bin]);
		}	
	}

	var vals = vals.map( (v,i) => ({id:i,val:v, mean:null, bin: bins(v)}) );

    var first = d3.select("body").append('svg')
			.attr('class', 'left')
			.attr('width', (2*w + 3*m))
			.attr('height', (2*h + 3*m))
			.append('g')
			.attr('transform', 'translate(' + m + ',' + m + ')')
    	.selectAll('rect')
			.data(vals, x=>x.id)
    		.enter()
    		.append('rect')
				.attr('class', 'histogram')
				.attr('fill', 'green')
		//		.attr('x', '0')
				//.attr('y', '0')
			//.transition()
			//.delay(function(_, i) { return i * 200; })
				//.attr('y', d=> {if (typeof counter[pox(d.val)] == 'undefined') counter[pox(d.val)] = 0 ;return y(counter[pox(d.val)]++);})
				.attr('y', counter())
				//.attr('x', d=>pox(d.val))
				.attr('x', d=>x(d.bin))
			 	.attr('width', 13)
				.attr('height',13);

	d3.select('svg').selectAll('.histogram');
				//.on('mouseover', foo2)
				//.on('mouseout', bar);

	d3.select('svg').append('g').attr('class', 'x-axis')
		.attr('transform', 'translate(20,' + (h + m).toString() + ')')
		.call(xAxis);



	function takeSample(vals, size) {	
		var indexes = new Array;
		var rand =  Math.floor(Math.random() * vals.length);

		for (i=0;i<size;i++) {
			while(indexes.indexOf(rand) != -1) {
				rand = Math.floor(Math.random() * vals.length);
			}
			indexes.push(rand); 
		}
		return (vals.filter( v => indexes.some( d => d == v.id) ));
	}


//duplicates elements, then moves them to the other graph


function foo(values) {
	values = takeSample(values, 10);
	values = setMean(values);
	x.range([w + m, 2*w]);

	d3.select('svg')
		.selectAll('rect')
		.data(values, d=>d.id)
		.each(dupe);

	d3.select('svg').append('g').attr('class', 'x-axis')
		.attr('transform', 'translate(' + (w + 2*m).toString() + ',' + (h + m).toString() + ')')
		.call(xAxis);

}

function dupe(d, i) {
	var node = d3.select(this).node();
	var dup = d3.select(node.parentNode.appendChild(node.cloneNode(true)));

	d3.select(this).attr('fill-opacity', 1e-10)
		.attr('fill', 'black')
		.transition()
		.duration(4000)
		.attr('fill-opacity', 1)
		.attr('x', v=>x(v.mean))
		.attr('y', counter());
	// create axis 
}
// draws the mean line

d3.select('svg > g').selectAll('rect')
	.data([170], x=>x*1000)
	.enter()
	.append('rect')
	.attr('x', x)
	.attr('y', '0')
	.attr('width', '2')
	.attr('fill-opacity', 0.4)
	.attr('height', h )
	.attr('fill', 'red');

setTimeout(() => foo(vals), 1000);

function setMean(arr) {
		return (arr.map( (v,i,a) => {return v.mean = bins(a.reduce( (p,d) => (p + d.val) , 0) / arr.length), v}));
}

  </script>
</body>
</html>
